{% extends 'base.html' %}
{% block content %}
<div class="event-detail-container">
    <h2>{{ event.title }}</h2>

    {% if event.image %}
        <img src="{{ event.image.url }}" alt="Imagem de {{ event.title }}" class="event-image">
    {% endif %}
    <div style="text-align: center; margin-bottom: 20px;">
        <span class="event-type-badge">{{ event.event_type }}</span>
    </div>
    
    <div class="event-info-grid">
        <div class="event-info-card description-card">
            <div class="event-info-label">
                DescriÃ§Ã£o
            </div>
            <div class="event-info-value description-content">
                {{ event.description }}
            </div>
        </div>
    </div>
    
    {% if event.creator %}
    <div class="event-creator-info">
        <span>ğŸ‘¤</span>
        <span><strong>Organizador:</strong> {{ event.creator.username }}</span>
    </div>
    {% endif %}

    {% if event.professor %}
    <div class="event-professor-info">
        <span>ğŸ“</span>
        <span><strong>Professor ResponsÃ¡vel:</strong> {{ event.professor }}</span>
    </div>
    {% endif %}
    
    <hr>
    
    <div class="event-info-grid">
        <div class="event-info-card">
            <div class="event-info-label">
                ğŸ“… InÃ­cio
            </div>
            <div class="event-info-value">
                {{ event.initial_date|date:"d/m/Y" }} Ã s {{ event.event_start|date:"H:i" }}
            </div>
        </div>
        
        <div class="event-info-card">
            <div class="event-info-label">
                ğŸ“… TÃ©rmino
            </div>
            <div class="event-info-value">
                {{ event.final_date|date:"d/m/Y" }} Ã s {{ event.event_end|date:"H:i" }}
            </div>
        </div>
        
        <div class="event-info-card">
            <div class="event-info-label">
                ğŸ• DuraÃ§Ã£o Total
            </div>
            <div class="event-info-value">
                {{ event.calculated_duration_hours }} horas
            </div>
        </div>
        
        <div class="event-info-card highlight">
            <div class="event-info-label">
                ğŸ“ Local
            </div>
            <div class="event-info-value">
                {{ event.location }}
            </div>
        </div>
    </div>
    
    <div class="event-capacity {% if event.is_full %}full{% endif %}">
        <span>ğŸ‘¥ Participantes:</span>
        
        {% if request.user == event.creator %}
            <a href="{% url 'event_participants' pk=event.pk %}" 
               style="text-decoration: underline; color: inherit; font-weight: bold;"
               title="Clique para ver a lista de nomes">
                {{ event.participants.count }} / {{ event.max_capacity }}
            </a>
        {% else %}
            <span>{{ event.participants.count }} / {{ event.max_capacity }}</span>
        {% endif %}
    </div>
        
    <form method="post" action="{% url 'toggle_registration' pk=event.pk %}" class="registration-form">
        {% csrf_token %}
        
        {% if user.is_authenticated %}
            {% if user in event.participants.all %}
                <button type="submit" class="btn-unsubscribe">âŒ Cancelar InscriÃ§Ã£o</button>
            
            {% elif event.is_full %}
                <button type="button" class="btn-full" disabled>ğŸš« EVENTO LOTADO</button>
            
            {% elif user.user_type != 'Organizador' %}
                <button type="submit" class="btn-subscribe">âœ…
 Inscrever-se Agora</button>
            {% endif %}
        {% else %}
            <div class="login-message">
                ğŸ”’ FaÃ§a <a href="{% url 'login' %}">login</a> para se inscrever neste evento.
            </div>
        {% endif %}
        </form>
        
    <a href="{% url 'event_list' %}" class="back-link">â† Voltar Ã  Lista</a>
    
    {% if request.user == event.creator %}
        <a href="{% url 'event_edit' pk=event.pk %}" class="btn-edit {% if not event.event_finalized and event.is_over %}animacao-suave{% else %}animacao-destaque-edit{% endif %}">
        Editar Evento
        </a>
        {% endif %}
    {% if request.user == event.creator and not event.event_finalized and event.is_over %}
    
        <form method="post" action="{% url 'event_final' pk=event.pk %}" class="finalize-form" id="form-finalizar">
            
            {% csrf_token %}
            <button type="submit" class="btn-finalize animacao-destaque">Finalizar Evento</button>
        </form>

        {% endif %}

        <div id="loading-overlay">
        <div class="spinner"></div>
            <h3>Finalizando evento e enviando certificados...</h3>
            <p>Por favor, aguarde. Isso pode levar alguns segundos.</p>
        </div>

</div> <script>
    document.addEventListener('DOMContentLoaded', function() {
        const formFinalizar = document.getElementById('form-finalizar');
        const loadingOverlay = document.getElementById('loading-overlay');

        if (formFinalizar) {
            formFinalizar.addEventListener('submit', function(e) {
                // NÃ£o impede o envio (nÃ£o usa e.preventDefault), 
                // apenas mostra o loading antes do navegador carregar a prÃ³xima pÃ¡gina.
                
                // 1. Mostra a tela de carregamento
                loadingOverlay.style.display = 'flex';
                
                // 2. Opcional: Desabilita o botÃ£o para evitar clique duplo
                const btn = formFinalizar.querySelector('button');
                btn.disabled = true;
                btn.innerText = "Processando...";
            });
        }
    });
</script>
{% endblock %}