{% extends 'base.html' %}

{% load static %}
{% block title %}Registro de Usuário{% endblock %}

{% block content %}
<div class="register-container">
<form method="POST" action="{% url 'register' %}" id="register-form">

    <h2>Registro</h2>
    {% csrf_token %}

    {# mostra erros não vinculados a campos (se houver) #}
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for err in form.non_field_errors %}
                <p>{{ err }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <p>
        {{ form.name.label_tag }}
        {{ form.name }}
        {% for error in form.username.errors %}
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>

    <p>
        {{ form.username.label_tag }}
        {{ form.username }}
        {% for error in form.username.errors %}
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>
    
    <p>
        {{ form.email.label_tag }}
        {{ form.email }}
        {% for error in form.email.errors %}
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>
    
    <p>
        {{ form.password.label_tag }}
        {{ form.password }}
        {% for error in form.password.errors %}
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>
    
    <p>
        {{ form.password_confirm.label_tag }}
        {{ form.password_confirm }}
        {% for error in form.password_confirm.errors %}
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>
    
    <p>
        {{ form.phone.label_tag }}
        {{ form.phone }}
        {% for error in form.phone.errors %}
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>

    <p>
        {{ form.institution.label_tag }}
        {{ form.institution }}
        {% for error in form.institution.errors %}
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>

    <p>

        {{ form.user_type.label_tag }}
        {{ form.user_type }}
        {% for error in form.user_type.errors %}
        
            <span class="field-error">{{ error }}</span>
        {% endfor %}
    </p>
    {% csrf_token %}
    <button type="submit" class="btn-register">Registrar</button>
</form>
        <div id="loading-overlay">
        <div class="spinner"></div>
            <h3>Criando o usuário, verifique o Gmail para ver a mensagem de saudação.</h3>
            <p>Por favor, aguarde. Isso pode levar alguns segundos.</p>
        </div>

</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.10/jquery.mask.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Pegamos o formulário pelo ID novo que criamos
        const registerForm = document.getElementById('register-form');
        const loadingOverlay = document.getElementById('loading-overlay');

        if (registerForm) {
            registerForm.addEventListener('submit', function(e) {
                // Verifica se o formulário é válido antes de mostrar o loading
                // (Isso evita que o loading apareça se o navegador bloquear por campo obrigatório vazio)
                if (!registerForm.checkValidity()) {
                    return; 
                }

                // 2. Mostra a tela de carregamento
                loadingOverlay.style.display = 'flex';
                
                // 3. Desabilita o botão e muda o texto
                const btn = registerForm.querySelector('button[type="submit"]');
                if (btn) {
                    btn.disabled = true;
                    btn.innerText = "Registrando...";
                }
            });
        }
    });
</script>
{% endblock %}